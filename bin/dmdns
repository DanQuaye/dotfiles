#!/usr/bin/env bash

# exit when script tries to use an undeclared variable
set -o nounset

die() {
    echo "$*"
    exit 1
}

getip() {
    docker-machine ip $1
}

writefile() {
    local tld="$1"
    local confdir="$2"
    local machine="$3"
    local ip="$4"
    local domain="${machine}.${tld}"
    echo "Creating dnsmasq file for ${domain}"
    echo "address=/${domain}/${ip}" > "${confdir}/${domain}"
}

main () {

    local tld="docker"
    local confdir="$(brew --prefix)/etc/dnsmasq.d"
    local ip
    declare -a dockervms=`docker-machine ls -q`

    for m in $dockervms; do
        ip=$(getip ${m})
        writefile $tld $confdir $m $ip
    done
}

main "$@"

