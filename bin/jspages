#!/usr/bin/env bash

# exit when script tries to use an undeclared variable
set -o nounset

SCRIPT_NAME=$(basename "$0")
oneline_usage="$SCRIPT_NAME"

usage()
{
    cat <<-EndUsage
		Usage: $oneline_usage
		Use '$INSTALL_SH -h' for more information
	EndUsage
    exit 1
}

helpinfo()
{
cat <<-EndHelp
Usage: $oneline_usage

Build the project and push to gh-pages branch

Flags:
    -h
        Show usage info
    -c
        Create the gh-pages orphan branch
EndHelp
exit 0
}

die() {
    echo "$*"
    exit 1
}

setup()
{
    echo "Creating orphan gh-pages branch"
    git checkout --orphan gh-pages
    git unstage .
}

build()
{
    npm run build
    if [ "$CREATE_BRANCH" == "y" ]; then
        setup
    else
        git checkout gh-pages
    fi
    cp -r ./dist/* .;
    git add app.js index.html style.css images
    git ci -m 'Updating pages'
    git push origin gh-pages

    if [ "$CREATE_BRANCH" == "y" ]; then
        git clean -dfx
    fi

    git checkout master
}


CREATE_BRANCH="n"

while getopts "hc" opt "$@"; do
    case "$opt" in
        h)
            helpinfo
            ;;
        c)
            CREATE_BRANCH="y"
            echo "Creating gh-pages branch"
            ;;
    esac
done

build "${@:$OPTIND}"

